```markdown
# S3 — 仓位管理（基于 S1 策略，使用 Kelly 公式）

目标：在 S1 的基础策略上加入基于凯利公式（Kelly criterion）的仓位管理模块，使仓位按历史绩效动态调整，以期长期降低回撤并提高风险调整后收益。S3 提供原理说明、参数估计方法、回测集成步骤、伪代码示例以及实务建议和复现命令。

## 1. 简短结论
- Kelly 公式给出理论上长期最大化对数财富增长的仓位比例 f*；但估计噪声、交易成本和样本偏差会导致直接使用 f* 风险过大。实务上使用 fractional Kelly（例如 1/4 或 1/2 Kelly）并加上下限/上限、平滑与监控，是更稳健的做法。

## 2. 基本概念和公式
- 离散（胜/负、按交易）形式（适合以“每笔交易盈亏”为单位的估计）:
  - 设 p = 胜率（赢的概率），q = 1-p；g = 平均盈利（正数），l = 平均亏损（正数）；令 b = g/l。
  - Kelly: f* = p - q / b

- 连续（均值-方差近似，适合按日收益或连续收益序列）:
  - 设 μ = 期望超额收益（同一时间尺度），σ^2 = 收益方差。
*** End Patch


说明：f* 表示建议投入的资金比例（占总资金）。若为负，表示不应开仓；若 >1，暗示理论上可杠杆，但实际通常受限。
